<div id="myCard" style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">

  <!-- Contenedor Media -->
  <div style="margin-bottom: 0px; display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 900px;">
    <div style="width: 100%;">
      <div style="text-align: center; line-height: 1; font-size: initial;">
        {{#Imagen}}
        <div class="video-wrapper">
          <div class="video-container">
            <canvas id="ambient-canvas"></canvas>
            <!-- Mantenemos preload="auto" para una mejor carga -->
            <video id="videoAnki" src="{{Imagen}}" width="100%" preload="auto" playsinline></video>
            <button id="playPauseBottomBtn" class="video-control-button-bottom" aria-label="Reproducir/Pausar">
                <svg class="icon icon-play" viewBox="0 0 24 24" width="70%" height="70%" fill="currentColor" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M8 6 L19 12 L8 18 Z" /></svg>
                <svg class="icon icon-pause" viewBox="0 0 24 24" width="70%" height="70%" fill="currentColor" aria-hidden="true"><rect x="6" y="5" width="4" height="14" rx="2" ry="2"></rect><rect x="14" y="5" width="4" height="14" rx="2" ry="2"></rect></svg>
            </button>
          </div>
        </div>
        {{/Imagen}}
      </div>
    </div>
  </div>

  {{#Ingles}}
  <div class="expression-container" style="margin-top: 5px; width: 100%; max-width: 700px;">
    
    <div class="expression" id="dynamic-subtitle-container" style="position: relative; min-height: 50px;"></div>

    <div id="subtitle-controls" style="display: none; justify-content: center; align-items: center; gap: 20px; margin-top: 10px; user-select: none;">
        <button id="prev-btn" class="sub-btn-icon" aria-label="Anterior">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="72px" height="72px"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </button>
        <span id="sub-counter"></span>
        <button id="next-btn" class="sub-btn-icon" aria-label="Siguiente">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="72px" height="72px"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>
        </button>
    </div>
    
    <!-- ========================================================== -->
    <!-- ===== SCRIPT CON LÓGICA ANTI-LAG (VERSIÓN FINAL) ===== -->
    <!-- ========================================================== -->
    <script>
    (function () {
        const rawHTML = `{{Ingles}}`;
        const subtitleContainer = document.getElementById('dynamic-subtitle-container');
        const controlsContainer = document.getElementById('subtitle-controls');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const counter = document.getElementById('sub-counter');
        const video = document.getElementById('videoAnki');

        function decodeText(b64) { try { return decodeURIComponent(atob(b64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); } catch (e) { return b64; } }
        function styleText(text) { return text.replace(/\(\((.*?)\)\)/g, '<span class="study-word">$1</span>'); }

        const dataMatch = rawHTML.match(/<!--DATA\|(.*?)##(.*?)-->/);

        if (video && dataMatch && dataMatch[1] && dataMatch[2]) {
            const sentencesEncoded = dataMatch[1].split('|');
            const startTimes = dataMatch[2].split(',').map(Number);
            let currentIndex = -1;
            let hideControlsTimer;

            // =========================> INICIO DE LA MODIFICACIÓN <=========================
            // Solo mostramos los controles si hay más de una oración.
            const showControls = sentencesEncoded.length > 1;

            if (showControls) {
                // Si hay múltiples diálogos, hacemos el contador visible.
                // Los botones ya son visibles porque todo el contenedor de controles se mostrará.
            } else {
                // Si solo hay un diálogo, nos aseguramos de que los controles (incluyendo el contador) no se muestren.
                controlsContainer.style.display = 'none';
            }

            const startHideTimer = () => { if (!showControls) return; clearTimeout(hideControlsTimer); hideControlsTimer = setTimeout(() => { controlsContainer.classList.add('controls-hidden'); }, 1500); };
            const revealControls = () => { if (!showControls) return; clearTimeout(hideControlsTimer); controlsContainer.classList.remove('controls-hidden'); };
            const pauseHideTimer = () => { clearTimeout(hideControlsTimer); };
            
            function updateDisplay(index, shouldSeek) {
                if (index === currentIndex) return;
                currentIndex = index;
                const decodedSentence = decodeText(sentencesEncoded[index]);
                subtitleContainer.innerHTML = styleText(decodedSentence);
                
                // Solo actualizamos el contador y los botones si los controles están activos.
                if (showControls) {
                    counter.textContent = `${index + 1} / ${sentencesEncoded.length}`;
                    prevBtn.disabled = index === 0;
                    nextBtn.disabled = index === sentencesEncoded.length - 1;
                }

                if (shouldSeek) {
                    const wasPlaying = !video.paused;
                    video.addEventListener('seeked', function onSeeked() {
                        if (wasPlaying) video.play().catch(e => {});
                        video.removeEventListener('seeked', onSeeked);
                    }, { once: true });
                    video.currentTime = startTimes[index] / 1000;
                }
            }
            // ==========================> FIN DE LA MODIFICACIÓN <==========================

            const nextPart = () => { if (currentIndex < sentencesEncoded.length - 1) updateDisplay(currentIndex + 1, true); };
            const prevPart = () => { if (currentIndex > 0) updateDisplay(currentIndex - 1, true); };
            
            prevBtn.addEventListener('click', () => {
                prevPart();
                if (!video.paused) { revealControls(); startHideTimer(); }
            });
            nextBtn.addEventListener('click', () => {
                nextPart();
                if (!video.paused) { revealControls(); startHideTimer(); }
            });
            
            video.addEventListener('play', () => {
                // =========================> MODIFICACIÓN AQUÍ <=========================
                // Solo mostramos los controles al reproducir si hay más de un diálogo.
                if (showControls && controlsContainer.style.display === 'none') {
                    controlsContainer.style.display = 'flex';
                }
                // Actualizamos el índice si es la primera vez que se reproduce.
                if (currentIndex === -1) {
                    updateDisplay(0, true);
                }
                // =======================================================================
                revealControls();
                startHideTimer(); 
            });

            video.addEventListener('pause', () => {
                revealControls();
                pauseHideTimer(); 
            });
            
            video.addEventListener('timeupdate', () => {
                if (video.seeking) return;
                const currentTimeMs = video.currentTime * 1000;
                
                let newIndex = -1;
                for (let i = startTimes.length - 1; i >= 0; i--) {
                    if (currentTimeMs >= startTimes[i] - 100) {
                        newIndex = i;
                        break;
                    }
                }
                
                if (newIndex !== -1 && newIndex !== currentIndex) {
                    updateDisplay(newIndex, false);
                }
            });

            let touchStartX = null;
            subtitleContainer.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].clientX; }, { passive: true });
            subtitleContainer.addEventListener('touchend', (e) => {
                if (touchStartX === null) return;
                const deltaX = e.changedTouches[0].clientX - touchStartX;
                if (Math.abs(deltaX) > 50) { 
                    if (deltaX < 0) { nextPart(); } else { prevPart(); }
                }
                touchStartX = null;
            });
            subtitleContainer.addEventListener('click', (e) => {
                const rect = subtitleContainer.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                if (clickX < rect.width * 0.4) { prevPart(); } 
                else if (clickX > rect.width * 0.6) { nextPart(); }
            });

            controlsContainer.addEventListener('mouseenter', () => { if (!video.paused) { revealControls(); pauseHideTimer(); } });
            controlsContainer.addEventListener('mouseleave', () => { if (!video.paused) { startHideTimer(); } });
            
        } else {
            subtitleContainer.innerHTML = styleText(rawHTML);
        }
    })();
    </script>
    
  </div>
  {{/Ingles}}

  <script>
    function initializeAmbientMode(videoElement){const canvas=document.getElementById('ambient-canvas');if(!videoElement||!canvas)return;const ctx=canvas.getContext('2d');canvas.width=16;canvas.height=9;let animationFrameId;function drawGlow(){if(videoElement.paused||videoElement.ended){ctx.drawImage(videoElement,0,0,canvas.width,canvas.height);cancelAnimationFrame(animationFrameId);return}ctx.drawImage(videoElement,0,0,canvas.width,canvas.height);animationFrameId=requestAnimationFrame(drawGlow)}videoElement.addEventListener('play',()=>{canvas.classList.add('glow-active');cancelAnimationFrame(animationFrameId);drawGlow()})}
    function togglePlayPauseVideo(event){var currentVideo=document.getElementById('videoAnki');if(!currentVideo)return;if(event){event.stopPropagation()}if(currentVideo.paused||currentVideo.ended){currentVideo.muted=false;if(currentVideo.readyState===0){currentVideo.load()}currentVideo.play().catch(e=>{})}else{currentVideo.pause()}}
    function updateVideoBottomButtonState(){var currentVideo=document.getElementById('videoAnki');var currentButton=document.getElementById('playPauseBottomBtn');if(!currentVideo||!currentButton)return;const isPaused=currentVideo.paused||currentVideo.ended;currentButton.classList.toggle('is-playing',!isPaused);currentButton.setAttribute('aria-label',isPaused?'Reproducir':'Pausar')}
    function setupVideoPlayer(){var videoElement=document.getElementById('videoAnki');if(videoElement){var videoContainer=videoElement.closest('.video-container');if(videoContainer){videoContainer.addEventListener('click',togglePlayPauseVideo)}initializeAmbientMode(videoElement);videoElement.classList.remove('video-ready');const makeVideoVisible=()=>{videoElement.classList.add('video-ready');videoElement.removeEventListener('loadeddata',makeVideoVisible)};if(videoElement.readyState>=2){makeVideoVisible()}else{videoElement.addEventListener('loadeddata',makeVideoVisible)}videoElement.addEventListener('play',updateVideoBottomButtonState);videoElement.addEventListener('pause',updateVideoBottomButtonState);videoElement.addEventListener('ended',updateVideoBottomButtonState);updateVideoBottomButtonState();videoElement.muted=false;var playPromise=videoElement.play();if(playPromise!==undefined){playPromise.catch(error=>{})}}}
    if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',setupVideoPlayer)}else{setupVideoPlayer()}
  </script>
</div>
